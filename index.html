<!DOCTYPE html>
<html>
    <!-- markdown-it -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script src="./lib/highlightjs-line-numbers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.2/markdown-it.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- self  -->
    <link rel="stylesheet" href="./style.css">
    <script src="./src/list.js"></script>

    <head><title id="title">wuyugu的小站</title></head>
    <body>hello（一无音）</body>
    <script type="module">
        import sub_plugin from "./lib/sub.mjs";
        import sup_plugin from "./lib/sup.mjs";
        import footnote_plugin from "./lib/footnotes.mjs";
        import math_plugin from "./lib/katex.mjs";
        import abbr_plugin from "./lib/abbr.mjs";
        import container_plugin from "./lib/container.mjs"

        async function htmlAdder(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            document.body.innerHTML = "";
            Array.from(temp.childNodes).forEach(node => {
                if (node.nodeName !== 'SCRIPT') {
                    document.body.appendChild(node.cloneNode(true));
                }
            });
            await new Promise(resolve => requestAnimationFrame(resolve));
            await new Promise(resolve => requestAnimationFrame(resolve));
            /* 这byd是什么玩意 */
            Array.from(temp.querySelectorAll('script')).forEach(script => {
                const newScript = document.createElement('script');
                if (script.src) newScript.src = script.src;
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript);
            });
        }

        const md = window.markdownit({
            highlight: function (str, lang, sti="") {
                if (lang && hljs.getLanguage(lang)) {
                    var res = hljs.highlight(str, {language: lang, ignoreIllegals: true}).value;
                    var settings = sti.split(" ");
                    res = hljs.lineNumbersValue(res, {
                        onlyTable : !settings.includes("line-numbers")
                    });
                    return '<pre class="hljs">' + res + '</pre>';
                }
                return '<pre class="hljs">' + md.utils.escapeHtml(str) + '</pre>';
            }
        })
        .use(sub_plugin).use(sup_plugin)
        .use(footnote_plugin).use(math_plugin)
        .use(abbr_plugin).use(container_plugin,"fold",{
            validate: function(params) {
                return params.trim().match(/^(warning|success|info)(\[(.*)\])?$/);
            },
            render: function (tokens, idx) {
                var m = tokens[idx].info.trim().match(/^(warning|success|info)(\[(.*)\])?$/);
                if (tokens[idx].nesting === 1) {
                    let sum = md.renderInline(m[3]?m[3]:"");
                    if(!sum)sum = {warning:"警告",success:"成功",info:"提示"}[m[1]];
                    return '<details class="' + m[1] + '"><summary>' + sum + '</summary><div class="det-in">';
                } else {
                    return '</div></details>\n';
                }
            }
        });
        const defaultRender = md.renderer.rules.link_open || 
            function(tokens, idx, options, env, self) {
                return self.renderToken(tokens, idx, options);
            };
        md.renderer.rules.link_open = function(tokens, idx, options, env, self) {
            const token = tokens[idx];
            const hrefIndex = token.attrIndex('href');
            if (hrefIndex >= 0) {
                const href = token.attrs[hrefIndex][1];
                console.log(href);
                if (href.startsWith("-")) {
                    const processedHref = "/?p="+href.substring(1);
                    token.attrs[hrefIndex][1] = processedHref;
                } else {
                    token.attrSet('target', '_blank');
                    token.attrSet('rel', 'noopener noreferrer');
                }
            }    
            return defaultRender(tokens, idx, options, env, self);
        };

        const urlParams = new URLSearchParams(window.location.search);
        var p = urlParams.get("p");
        if(!p) p = "index";
        if(!pagesList[p]){
            alert(`页面${p}不存在！`);
        }
        else{
            let info = pagesList[p];
            let content = get(p,info)
                .catch(err=>alert(`解析${p}出错：${err}`));
            if(info.type == "text"){
                content
                    .then(content=>{document.body.textContent = content;});
            }
            else if(info.type == "html"){
                content
                    .then(content=>{htmlAdder(content);});
            }
            else if(info.type == "markdown"){
                content
                    .then(content=>{document.body.innerHTML = md.render(content);});
                    
            }
            else alert(`不存在的页面类型：${info.type}`);
        }
    </script>
</html>